;
; AR2F80A 2.1.0m  TONY FORBES  December 1994
;
; a = a^2  (using FFT modulo F_8)
;
; xsqufft80 (&a, d, &f);
;
; Registers:   EAX = &a, EDX = d = d(a), 
;              EDX = &f, a 9225-digit work area (36900 bytes)
; Assumptions: d(a) > 0
;              a has sufficient space according to the 
;              following scheme:
;              
;                 0 < d(a) <=   45  :  cap(a) >= 2*d(a)
;                45 < d(a) <=   60  :  cap(a) >= 122
;                60 < d(a) <=   90  :  cap(a) >= 2*d(a)
;                90 < d(a) <=  120  :  cap(a) >= 242
;               120 < d(a) <=  240  :  cap(a) >= 482
;               240 < d(a) <=  480  :  cap(a) >= 962
;               480 < d(a) <=  960  :  cap(a) >= 1922
;               960 < d(a) <= 1920  :  cap(a) >= 3842
;              1920 < d(a)          :  cap(a) >= 2*d(a)
;
;              max(2*d(a), min(4*d(a), 3842)) is sufficient
;
; Finite Fourier Transform for a => a^2.
;
; F  the Fermat number F(8) =  2^256 + 1.
; D  the dimension of the Fourier transform.
; G  a Dth root of unity modulo F.
; M  the base for representation of a, m = 2^120.
;
; Parameters for FFT with F = 2^256 + 1 and M = 2^120
;
;   log2 D     D           G           Nmax
;    
;     10     1024     2^192-2^64     2^61440
;      9      512          2         2^30720
;      8      256          4         2^15360
;      7      128         16         2^7680
;      6       64        256         2^3840
;      5       32      65536         2^1920
;      4       16       2^32         2^960
;      3        8       2^64         2^480
;
; F[X](k) = Sum[i=0 to D-1: X(i)G^k (mod F)
;
; Fast Fourier Transform
;
;    X(D,k,i) = X(i)
;    X(d,k,i) = X(2d,k,i) + X(2d,k,i+d)G^dk  (mod F)
;    F[X](k)  = X(1,k,0)
;
; Convolution Theorem:  F[(F[X]'.F[X]')] = D X*X,
;
; where  F[X]'  is the permutation of the vector  F[X]
; defined by  F[X]'(0) = F[X](0), F[X]'(i) = F[X](D-i),
; i = 1, 2, ..., D-1.
;
; a   = Sum[i=0 to D/2-1: 2^(iM) X(i)]
; a^2 = Sum[i=0 to D-2: 2^(iM) [X*X](i)]
; 
_DATA   segment dword public 'DATA'
         public _AR2F80data
_AR2F80data dd 0
         org    _AR2F80data
Zcx      dd     0        ; Save ECX
Zbp      dd     0        ; Save EBP
Zsi      dd     0        ; Save ESI
Zdi      dd     0        ; Save EDI
ZYptr    dd     0        ; EAX = &a
ZXptr    dd     0        ; EBX = &f
;
; Constants for FFT array
LnF      =      9*4      ; length of F
LnM      =      15       ; length of M
Lk0      =      0        ; offset to block 0
Lk1      =      256*9*4  ; offset to block 1
Lk2      =      512*9*4  ; offset to block 2
Lk3      =      768*9*4  ; offset to block 3
Lk4      =      1024*9*4 ; offset to end of FFT array
;
; FFT work areas
ZU       DD     17 dup (0)
ZW       DD     9 dup (0)
;
; Global FFT variables
ZGDim    DD     0        ; Dimension D
ZGlgD    DD     0        ; log2 D
ZGLbF    DD     0        ; F-block size = LnF*1024/D 
;
; Variables for XfftA
ZGe      DD     0
ZFd      DD     0
ZFe      DD     0
ZFb      DD     0
ZFI      DD     0
ZF2k     DD     0
ZFkd     DD     0
ZFkc     DD     0
ZFkb     DD     0
;
; Data for XfftQ
ZStab    DD     0        ; X(i)^2 control table
ZSind    DD     0        ; X(i)^2 control index
ZSpar    DD     TqA-TqA,2*(1024+17)
         DD     Tq9-TqA,2*(512+17)
         DD     Tq8-TqA,2*(256+9)
         DD     Tq7-TqA,2*(128+9)
         DD     Tq6-TqA,2*(64+5)
         DD     Tq5-TqA,2*(32+5)
         DD     Tq4-TqA,2*(16+3)
         DD     Tq3-TqA,2*(8+3)
;
; Bit reversal table, i => LnF * b(i), 
; b(i) = i bit-reversed modulo 1024
Tb  DW   0,18432,9216,27648,4608,23040,13824,32256 
    DW   2304,20736,11520,29952,6912,25344,16128,34560 
    DW   1152,19584,10368,28800,5760,24192,14976,33408 
    DW   3456,21888,12672,31104,8064,26496,17280,35712 
    DW   576,19008,9792,28224,5184,23616,14400,32832 
    DW   2880,21312,12096,30528,7488,25920,16704,35136 
    DW   1728,20160,10944,29376,6336,24768,15552,33984 
    DW   4032,22464,13248,31680,8640,27072,17856,36288 
;
    DW   288,18720,9504,27936,4896,23328,14112,32544 
    DW   2592,21024,11808,30240,7200,25632,16416,34848 
    DW   1440,19872,10656,29088,6048,24480,15264,33696 
    DW   3744,22176,12960,31392,8352,26784,17568,36000 
    DW   864,19296,10080,28512,5472,23904,14688,33120 
    DW   3168,21600,12384,30816,7776,26208,16992,35424 
    DW   2016,20448,11232,29664,6624,25056,15840,34272 
    DW   4320,22752,13536,31968,8928,27360,18144,36576 
;
    DW   144,18576,9360,27792,4752,23184,13968,32400 
    DW   2448,20880,11664,30096,7056,25488,16272,34704 
    DW   1296,19728,10512,28944,5904,24336,15120,33552 
    DW   3600,22032,12816,31248,8208,26640,17424,35856 
    DW   720,19152,9936,28368,5328,23760,14544,32976 
    DW   3024,21456,12240,30672,7632,26064,16848,35280 
    DW   1872,20304,11088,29520,6480,24912,15696,34128 
    DW   4176,22608,13392,31824,8784,27216,18000,36432 
;
    DW   432,18864,9648,28080,5040,23472,14256,32688 
    DW   2736,21168,11952,30384,7344,25776,16560,34992 
    DW   1584,20016,10800,29232,6192,24624,15408,33840 
    DW   3888,22320,13104,31536,8496,26928,17712,36144 
    DW   1008,19440,10224,28656,5616,24048,14832,33264 
    DW   3312,21744,12528,30960,7920,26352,17136,35568 
    DW   2160,20592,11376,29808,6768,25200,15984,34416 
    DW   4464,22896,13680,32112,9072,27504,18288,36720 
;
    DW   72,18504,9288,27720,4680,23112,13896,32328 
    DW   2376,20808,11592,30024,6984,25416,16200,34632 
    DW   1224,19656,10440,28872,5832,24264,15048,33480 
    DW   3528,21960,12744,31176,8136,26568,17352,35784 
    DW   648,19080,9864,28296,5256,23688,14472,32904 
    DW   2952,21384,12168,30600,7560,25992,16776,35208 
    DW   1800,20232,11016,29448,6408,24840,15624,34056 
    DW   4104,22536,13320,31752,8712,27144,17928,36360 
;
    DW   360,18792,9576,28008,4968,23400,14184,32616 
    DW   2664,21096,11880,30312,7272,25704,16488,34920 
    DW   1512,19944,10728,29160,6120,24552,15336,33768 
    DW   3816,22248,13032,31464,8424,26856,17640,36072 
    DW   936,19368,10152,28584,5544,23976,14760,33192 
    DW   3240,21672,12456,30888,7848,26280,17064,35496 
    DW   2088,20520,11304,29736,6696,25128,15912,34344 
    DW   4392,22824,13608,32040,9000,27432,18216,36648 
;
    DW   216,18648,9432,27864,4824,23256,14040,32472 
    DW   2520,20952,11736,30168,7128,25560,16344,34776 
    DW   1368,19800,10584,29016,5976,24408,15192,33624 
    DW   3672,22104,12888,31320,8280,26712,17496,35928 
    DW   792,19224,10008,28440,5400,23832,14616,33048 
    DW   3096,21528,12312,30744,7704,26136,16920,35352 
    DW   1944,20376,11160,29592,6552,24984,15768,34200 
    DW   4248,22680,13464,31896,8856,27288,18072,36504 

;
    DW   504,18936,9720,28152,5112,23544,14328,32760 
    DW   2808,21240,12024,30456,7416,25848,16632,35064 
    DW   1656,20088,10872,29304,6264,24696,15480,33912 
    DW   3960,22392,13176,31608,8568,27000,17784,36216 
    DW   1080,19512,10296,28728,5688,24120,14904,33336 
    DW   3384,21816,12600,31032,7992,26424,17208,35640 
    DW   2232,20664,11448,29880,6840,25272,16056,34488 
    DW   4536,22968,13752,32184,9144,27576,18360,36792 
;
    DW   36,18468,9252,27684,4644,23076,13860,32292 
    DW   2340,20772,11556,29988,6948,25380,16164,34596 
    DW   1188,19620,10404,28836,5796,24228,15012,33444 
    DW   3492,21924,12708,31140,8100,26532,17316,35748 
    DW   612,19044,9828,28260,5220,23652,14436,32868 
    DW   2916,21348,12132,30564,7524,25956,16740,35172 
    DW   1764,20196,10980,29412,6372,24804,15588,34020 
    DW   4068,22500,13284,31716,8676,27108,17892,36324 
;
    DW   324,18756,9540,27972,4932,23364,14148,32580 
    DW   2628,21060,11844,30276,7236,25668,16452,34884 
    DW   1476,19908,10692,29124,6084,24516,15300,33732 
    DW   3780,22212,12996,31428,8388,26820,17604,36036 
    DW   900,19332,10116,28548,5508,23940,14724,33156 
    DW   3204,21636,12420,30852,7812,26244,17028,35460 
    DW   2052,20484,11268,29700,6660,25092,15876,34308 
    DW   4356,22788,13572,32004,8964,27396,18180,36612 
;
    DW   180,18612,9396,27828,4788,23220,14004,32436 
    DW   2484,20916,11700,30132,7092,25524,16308,34740 
    DW   1332,19764,10548,28980,5940,24372,15156,33588 
    DW   3636,22068,12852,31284,8244,26676,17460,35892 
    DW   756,19188,9972,28404,5364,23796,14580,33012 
    DW   3060,21492,12276,30708,7668,26100,16884,35316 
    DW   1908,20340,11124,29556,6516,24948,15732,34164 
    DW   4212,22644,13428,31860,8820,27252,18036,36468 
;
    DW   468,18900,9684,28116,5076,23508,14292,32724 
    DW   2772,21204,11988,30420,7380,25812,16596,35028 
    DW   1620,20052,10836,29268,6228,24660,15444,33876 
    DW   3924,22356,13140,31572,8532,26964,17748,36180 
    DW   1044,19476,10260,28692,5652,24084,14868,33300 
    DW   3348,21780,12564,30996,7956,26388,17172,35604 
    DW   2196,20628,11412,29844,6804,25236,16020,34452 
    DW   4500,22932,13716,32148,9108,27540,18324,36756 
;
    DW   108,18540,9324,27756,4716,23148,13932,32364 
    DW   2412,20844,11628,30060,7020,25452,16236,34668 
    DW   1260,19692,10476,28908,5868,24300,15084,33516 
    DW   3564,21996,12780,31212,8172,26604,17388,35820 
    DW   684,19116,9900,28332,5292,23724,14508,32940 
    DW   2988,21420,12204,30636,7596,26028,16812,35244 
    DW   1836,20268,11052,29484,6444,24876,15660,34092 
    DW   4140,22572,13356,31788,8748,27180,17964,36396 
;
    DW   396,18828,9612,28044,5004,23436,14220,32652 
    DW   2700,21132,11916,30348,7308,25740,16524,34956 
    DW   1548,19980,10764,29196,6156,24588,15372,33804 
    DW   3852,22284,13068,31500,8460,26892,17676,36108 
    DW   972,19404,10188,28620,5580,24012,14796,33228 
    DW   3276,21708,12492,30924,7884,26316,17100,35532 
    DW   2124,20556,11340,29772,6732,25164,15948,34380 
    DW   4428,22860,13644,32076,9036,27468,18252,36684 
;
    DW   252,18684,9468,27900,4860,23292,14076,32508 
    DW   2556,20988,11772,30204,7164,25596,16380,34812 
    DW   1404,19836,10620,29052,6012,24444,15228,33660 
    DW   3708,22140,12924,31356,8316,26748,17532,35964 
    DW   828,19260,10044,28476,5436,23868,14652,33084 
    DW   3132,21564,12348,30780,7740,26172,16956,35388 
    DW   1980,20412,11196,29628,6588,25020,15804,34236 
    DW   4284,22716,13500,31932,8892,27324,18108,36540 
;
    DW   540,18972,9756,28188,5148,23580,14364,32796 
    DW   2844,21276,12060,30492,7452,25884,16668,35100 
    DW   1692,20124,10908,29340,6300,24732,15516,33948 
    DW   3996,22428,13212,31644,8604,27036,17820,36252 
    DW   1116,19548,10332,28764,5724,24156,14940,33372 
    DW   3420,21852,12636,31068,8028,26460,17244,35676 
    DW   2268,20700,11484,29916,6876,25308,16092,34524 
    DW   4572,23004,13788,32220,9180,27612,18396,36828 
;
; Tables for controlling X => X^2
;
; X(0)      = X(0)^2, 
; X(D-b(k)) = X(k)^2,  k = 1, 2, ..., D-1
;
; Cycle structure and table for D = 1024
;
; (0) c=1 
; (1,512,1023) c=3 
; (2,768,1021,257,510,514,767,3,256,1022,513,511) c=12 
; (4,896,1017,385,506,642,763,131,252,772,893,261,382,518,639,7,128,1020,769,509,258,766,515,255) c=24 
; (5,384,1018,641,507,130,764,771,253,260,894,517,383,6,640,1019,129,508,770,765,259,254,516,895) c=24 
; (8,960,1009,449,498,706,755,195,244,836,885,325,374,582,631,71,120,904,953,393,442,650,699,139,188,780,829,269,318,526,575,15,64,1016,897,505,386,762,643,251,132,892,773,381,262,638,519,127) c=48 
; (9,448,1010,705,499,194,756,835,245,324,886,581,375,70,632,903,121,392,954,649,443,138,700,779,189,268,830,525,319,14,576,1015,65,504,898,761,387,250,644,891,133,380,774,637,263,126,520,959) c=48 
; (10,704,1011,193,500,834,757,323,246,580,887,69,376,902,633,391,122,648,955,137,444,778,701,267,190,524,831,13,320,1014,577,503,66,760,899,249,388,890,645,379,134,636,775,125,264,958,521,447) c=48 
; (11,192,1012,833,501,322,758,579,247,68,888,901,377,390,634,647,123,136,956,777,445,266,702,523,191,12,832,1013,321,502,578,759,67,248,900,889,389,378,646,635,135,124,776,957,265,446,522,703) c=48 
; (16,992,993,481,482,738,739,227,228,868,869,357,358,614,615,103,104,936,937,425,426,682,683,171,172,812,813,301,302,558,559,47,48,976,977,465,466,722,723,211,212,852,853,341,342,598,599,87,
;  88,920,921,409,410,666,667,155,156,796,797,285,286,542,543,31,32,1008,961,497,450,754,707,243,196,884,837,373,326,630,583,119,72,952,905,441,394,698,651,187,140,828,781,317,270,574,527,63) c=96 
; (17,480,994,737,483,226,740,867,229,356,870,613,359,102,616,935,105,424,938,681,427,170,684,811,173,300,814,557,303,46,560,975,49,464,978,721,467,210,724,851,213,340,854,597,343,86,600,919,
;  89,408,922,665,411,154,668,795,157,284,798,541,287,30,544,1007,33,496,962,753,451,242,708,883,197,372,838,629,327,118,584,951,73,440,906,697,395,186,652,827,141,316,782,573,271,62,528,991) c=96 
; (18,736,995,225,484,866,741,355,230,612,871,101,360,934,617,423,106,680,939,169,428,810,685,299,174,556,815,45,304,974,561,463,50,720,979,209,468,850,725,339,214,596,855,85,344,918,601,407,
;  90,664,923,153,412,794,669,283,158,540,799,29,288,1006,545,495,34,752,963,241,452,882,709,371,198,628,839,117,328,950,585,439,74,696,907,185,396,826,653,315,142,572,783,61,272,990,529,479) c=96 
; (19,224,996,865,485,354,742,611,231,100,872,933,361,422,618,679,107,168,940,809,429,298,686,555,175,44,816,973,305,462,562,719,51,208,980,849,469,338,726,595,215,84,856,917,345,406,602,663,
;  91,152,924,793,413,282,670,539,159,28,800,1005,289,494,546,751,35,240,964,881,453,370,710,627,199,116,840,949,329,438,586,695,75,184,908,825,397,314,654,571,143,60,784,989,273,478,530,735) c=96 
; (20,864,997,353,486,610,743,99,232,932,873,421,362,678,619,167,108,808,941,297,430,554,687,43,176,972,817,461,306,718,563,207,52,848,981,337,470,594,727,83,216,916,857,405,346,662,603,151,
;  92,792,925,281,414,538,671,27,160,1004,801,493,290,750,547,239,36,880,965,369,454,626,711,115,200,948,841,437,330,694,587,183,76,824,909,313,398,570,655,59,144,988,785,477,274,734,531,223) c=96 
; (21,352,998,609,487,98,744,931,233,420,874,677,363,166,620,807,109,296,942,553,431,42,688,971,177,460,818,717,307,206,564,847,53,336,982,593,471,82,728,915,217,404,858,661,347,150,604,791,
;  93,280,926,537,415,26,672,1003,161,492,802,749,291,238,548,879,37,368,966,625,455,114,712,947,201,436,842,693,331,182,588,823,77,312,910,569,399,58,656,987,145,476,786,733,275,222,532,863) c=96 
; (22,608,999,97,488,930,745,419,234,676,875,165,364,806,621,295,110,552,943,41,432,970,689,459,178,716,819,205,308,846,565,335,54,592,983,81,472,914,729,403,218,660,859,149,348,790,605,279,
;  94,536,927,25,416,1002,673,491,162,748,803,237,292,878,549,367,38,624,967,113,456,946,713,435,202,692,843,181,332,822,589,311,78,568,911,57,400,986,657,475,146,732,787,221,276,862,533,351) c=96 
; (23,96,1000,929,489,418,746,675,235,164,876,805,365,294,622,551,111,40,944,969,433,458,690,715,179,204,820,845,309,334,566,591,55,80,984,913,473,402,730,659,219,148,860,789,349,278,606,535,
;  95,24,928,1001,417,490,674,747,163,236,804,877,293,366,550,623,39,112,968,945,457,434,714,691,203,180,844,821,333,310,590,567,79,56,912,985,401,474,658,731,147,220,788,861,277,350,534,607) c=96 
;
TqA DW   Lk4
    DW   0,Lk4 ; c=1 
    DW   36,18432,36828,Lk4 ; c=3 
    DW   72,27648,36756,9252,18360,18504,27612,108,9216,36792,18468,18396,Lk4 ; c=12 
    DW   144,32256,36612,13860,18216,23112,27468,4716,9072,27792,32148,9396  
    DW   13752,18648,23004,252,4608,36720,27684,18324,9288,27576,18540,9180,Lk4 ; c=24 
    DW   180,13824,36648,23076,18252,4680,27504,27756,9108,9360,32184,18612  
    DW   13788,216,23040,36684,4644,18288,27720,27540,9324,9144,18576,32220,Lk4 ; c=24 
;
    DW   288,34560,36324,16164,17928,25416,27180,7020,8784,30096,31860,11700  
    DW   13464,20952,22716,2556,4320,32544,34308,14148,15912,23400,25164,5004  
    DW   6768,28080,29844,9684,11448,18936,20700,540,2304,36576,32292,18180  
    DW   13896,27432,23148,9036,4752,32112,27828,13716,9432,22968,18684,4572,Lk4 ; c=48 
;
    DW   324,16128,36360,25380,17964,6984,27216,30060,8820,11664,31896,20916  
    DW   13500,2520,22752,32508,4356,14112,34344,23364,15948,4968,25200,28044  
    DW   6804,9648,29880,18900,11484,504,20736,36540,2340,18144,32328,27396  
    DW   13932,9000,23184,32076,4788,13680,27864,22932,9468,4536,18720,34524,Lk4 ; c=48 
;
    DW   360,25344,36396,6948,18000,30024,27252,11628,8856,20880,31932,2484  
    DW   13536,32472,22788,14076,4392,23328,34380,4932,15984,28008,25236,9612  
    DW   6840,18864,29916,468,11520,36504,20772,18108,2376,27360,32364,8964  
    DW   13968,32040,23220,13644,4824,22896,27900,4500,9504,34488,18756,16092,Lk4 ; c=48 
;
    DW   396,6912,36432,29988,18036,11592,27288,20844,8892,2448,31968,32436  
    DW   13572,14040,22824,23292,4428,4896,34416,27972,16020,9576,25272,18828  
    DW   6876,432,29952,36468,11556,18072,20808,27324,2412,8928,32400,32004  
    DW   14004,13608,23256,22860,4860,4464,27936,34452,9540,16056,18792,25308,Lk4 ; c=48
; 
    DW   576,35712,35748,17316,17352,26568,26604,8172,8208,31248,31284,12852  
    DW   12888,22104,22140,3708,3744,33696,33732,15300,15336,24552,24588,6156  
    DW   6192,29232,29268,10836,10872,20088,20124,1692,1728,35136,35172,16740  
    DW   16776,25992,26028,7596,7632,30672,30708,12276,12312,21528,21564,3132  
    DW   3168,33120,33156,14724,14760,23976,24012,5580,5616,28656,28692,10260  
    DW   10296,19512,19548,1116,1152,36288,34596,17892,16200,27144,25452,8748  
    DW   7056,31824,30132,13428,11736,22680,20988,4284,2592,34272,32580,15876  
    DW   14184,25128,23436,6732,5040,29808,28116,11412,9720,20664,18972,2268,Lk4 ; c=96 
;
    DW   612,17280,35784,26532,17388,8136,26640,31212,8244,12816,31320,22068  
    DW   12924,3672,22176,33660,3780,15264,33768,24516,15372,6120,24624,29196  
    DW   6228,10800,29304,20052,10908,1656,20160,35100,1764,16704,35208,25956  
    DW   16812,7560,26064,30636,7668,12240,30744,21492,12348,3096,21600,33084  
    DW   3204,14688,33192,23940,14796,5544,24048,28620,5652,10224,28728,19476  
    DW   10332,1080,19584,36252,1188,17856,34632,27108,16236,8712,25488,31788  
    DW   7092,13392,30168,22644,11772,4248,21024,34236,2628,15840,32616,25092  
    DW   14220,6696,23472,29772,5076,11376,28152,20628,9756,2232,19008,35676,Lk4 ; c=96 
;
    DW   648,26496,35820,8100,17424,31176,26676,12780,8280,22032,31356,3636  
    DW   12960,33624,22212,15228,3816,24480,33804,6084,15408,29160,24660,10764  
    DW   6264,20016,29340,1620,10944,35064,20196,16668,1800,25920,35244,7524  
    DW   16848,30600,26100,12204,7704,21456,30780,3060,12384,33048,21636,14652  
    DW   3240,23904,33228,5508,14832,28584,24084,10188,5688,19440,28764,1044  
    DW   10368,36216,19620,17820,1224,27072,34668,8676,16272,31752,25524,13356  
    DW   7128,22608,30204,4212,11808,34200,21060,15804,2664,25056,32652,6660  
    DW   14256,29736,23508,11340,5112,20592,28188,2196,9792,35640,19044,17244,Lk4 ; c=96 
;
    DW   684,8064,35856,31140,17460,12744,26712,21996,8316,3600,31392,33588  
    DW   12996,15192,22248,24444,3852,6048,33840,29124,15444,10728,24696,19980  
    DW   6300,1584,29376,35028,10980,16632,20232,25884,1836,7488,35280,30564  
    DW   16884,12168,26136,21420,7740,3024,30816,33012,12420,14616,21672,23868  
    DW   3276,5472,33264,28548,14868,10152,24120,19404,5724,1008,28800,36180  
    DW   10404,17784,19656,27036,1260,8640,34704,31716,16308,13320,25560,22572  
    DW   7164,4176,30240,34164,11844,15768,21096,25020,2700,6624,32688,29700  
    DW   14292,11304,23544,20556,5148,2160,28224,35604,9828,17208,19080,26460,Lk4 ; c=96 
;
    DW   720,31104,35892,12708,17496,21960,26748,3564,8352,33552,31428,15156  
    DW   13032,24408,22284,6012,3888,29088,33876,10692,15480,19944,24732,1548  
    DW   6336,34992,29412,16596,11016,25848,20268,7452,1872,30528,35316,12132  
    DW   16920,21384,26172,2988,7776,32976,30852,14580,12456,23832,21708,5436  
    DW   3312,28512,33300,10116,14904,19368,24156,972,5760,36144,28836,17748  
    DW   10440,27000,19692,8604,1296,31680,34740,13284,16344,22536,25596,4140  
    DW   7200,34128,30276,15732,11880,24984,21132,6588,2736,29664,32724,11268  
    DW   14328,20520,23580,2124,5184,35568,28260,17172,9864,26424,19116,8028,Lk4 ; c=96 
;
    DW   756,12672,35928,21924,17532,3528,26784,33516,8388,15120,31464,24372  
    DW   13068,5976,22320,29052,3924,10656,33912,19908,15516,1512,24768,34956  
    DW   6372,16560,29448,25812,11052,7416,20304,30492,1908,12096,35352,21348  
    DW   16956,2952,26208,32940,7812,14544,30888,23796,12492,5400,21744,28476  
    DW   3348,10080,33336,19332,14940,936,24192,36108,5796,17712,28872,26964  
    DW   10476,8568,19728,31644,1332,13248,34776,22500,16380,4104,25632,34092  
    DW   7236,15696,30312,24948,11916,6552,21168,29628,2772,11232,32760,20484  
    DW   14364,2088,23616,35532,5220,17136,28296,26388,9900,7992,19152,31068,Lk4 ; c=96 
;
    DW   792,21888,35964,3492,17568,33480,26820,15084,8424,24336,31500,5940  
    DW   13104,29016,22356,10620,3960,19872,33948,1476,15552,34920,24804,16524  
    DW   6408,25776,29484,7380,11088,30456,20340,12060,1944,21312,35388,2916  
    DW   16992,32904,26244,14508,7848,23760,30924,5364,12528,28440,21780,10044  
    DW   3384,19296,33372,900,14976,36072,24228,17676,5832,26928,28908,8532  
    DW   10512,31608,19764,13212,1368,22464,34812,4068,16416,34056,25668,15660  
    DW   7272,24912,30348,6516,11952,29592,21204,11196,2808,20448,32796,2052  
    DW   14400,35496,23652,17100,5256,26352,28332,7956,9936,31032,19188,12636,Lk4 ; c=96 
;
    DW   828,3456,36000,33444,17604,15048,26856,24300,8460,5904,31536,28980  
    DW   13140,10584,22392,19836,3996,1440,33984,34884,15588,16488,24840,25740  
    DW   6444,7344,29520,30420,11124,12024,20376,21276,1980,2880,35424,32868  
    DW   17028,14472,26280,23724,7884,5328,30960,28404,12564,10008,21816,19260  
    DW   3420,864,33408,36036,15012,17640,24264,26892,5868,8496,28944,31572  
    DW   10548,13176,19800,22428,1404,4032,34848,34020,16452,15624,25704,24876  
    DW   7308,6480,30384,29556,11988,11160,21240,20412,2844,2016,32832,35460  
    DW   14436,17064,23688,26316,5292,7920,28368,30996,9972,12600,19224,21852,Lk4 ; c=96 
;
; Cycle structure and table for D = 512
;
; (0) c=1 
; (2,512,1022) c=3 
; (4,768,1018,258,508,516,766,6,256,1020,514,510) c=12 
; (8,896,1010,386,500,644,758,134,248,776,890,266,380,524,638,14,128,1016,770,506,260,764,518,254) c=24 
; (10,384,1012,642,502,132,760,774,250,264,892,522,382,12,640,1014,130,504,772,762,262,252,520,894) c=24 
; (16,960,994,450,484,708,742,198,232,840,874,330,364,588,622,78,112,912,946,402,436,660,694,150,184,792,826,282,316,540,574,30,64,1008,898,498,388,756,646,246,136,888,778,378,268,636,526,126) c=48 
; (18,448,996,706,486,196,744,838,234,328,876,586,366,76,624,910,114,400,948,658,438,148,696,790,186,280,828,538,318,28,576,1006,66,496,900,754,390,244,648,886,138,376,780,634,270,124,528,958) c=48 
; (20,704,998,194,488,836,746,326,236,584,878,74,368,908,626,398,116,656,950,146,440,788,698,278,188,536,830,26,320,1004,578,494,68,752,902,242,392,884,650,374,140,632,782,122,272,956,530,446) c=48 
; (22,192,1000,834,490,324,748,582,238,72,880,906,370,396,628,654,118,144,952,786,442,276,700,534,190,24,832,1002,322,492,580,750,70,240,904,882,394,372,652,630,142,120,784,954,274,444,532,702) c=48 
; (32,992,962,482,452,740,710,230,200,872,842,362,332,620,590,110,80,944,914,434,404,692,662,182,152,824,794,314,284,572,542,62) c=32 
; (34,480,964,738,454,228,712,870,202,360,844,618,334,108,592,942,82,432,916,690,406,180,664,822,154,312,796,570,286,60,544,990) c=32 
; (36,736,966,226,456,868,714,358,204,616,846,106,336,940,594,430,84,688,918,178,408,820,666,310,156,568,798,58,288,988,546,478) c=32 
; (38,224,968,866,458,356,716,614,206,104,848,938,338,428,596,686,86,176,920,818,410,308,668,566,158,56,800,986,290,476,548,734) c=32 
; (40,864,970,354,460,612,718,102,208,936,850,426,340,684,598,174,88,816,922,306,412,564,670,54,160,984,802,474,292,732,550,222) c=32 
; (42,352,972,610,462,100,720,934,210,424,852,682,342,172,600,814,90,304,924,562,414,52,672,982,162,472,804,730,294,220,552,862) c=32 
; (44,608,974,98,464,932,722,422,212,680,854,170,344,812,602,302,92,560,926,50,416,980,674,470,164,728,806,218,296,860,554,350) c=32 
; (46,96,976,930,466,420,724,678,214,168,856,810,346,300,604,558,94,48,928,978,418,468,676,726,166,216,808,858,298,348,556,606) c=32 
Tq9 DW   Lk4
    DW   0,Lk4 ; c=1 
    DW   72,18432,36792,Lk4 ; c=3 
    DW   144,27648,36648,9288,18288,18576,27576,216,9216,36720,18504,18360,Lk4 ; c=12 
    DW   288,32256,36360,13896,18000,23184,27288,4824,8928,27936,32040,9576  
    DW   13680,18864,22968,504,4608,36576,27720,18216,9360,27504,18648,9144,Lk4 ; c=24 
    DW   360,13824,36432,23112,18072,4752,27360,27864,9000,9504,32112,18792  
    DW   13752,432,23040,36504,4680,18144,27792,27432,9432,9072,18720,32184,Lk4 ; c=24 
    DW   576,34560,35784,16200,17424,25488,26712,7128,8352,30240,31464,11880  
    DW   13104,21168,22392,2808,4032,32832,34056,14472,15696,23760,24984,5400  
    DW   6624,28512,29736,10152,11376,19440,20664,1080,2304,36288,32328,17928  
    DW   13968,27216,23256,8856,4896,31968,28008,13608,9648,22896,18936,4536,Lk4 ; c=48 
    DW   648,16128,35856,25416,17496,7056,26784,30168,8424,11808,31536,21096  
    DW   13176,2736,22464,32760,4104,14400,34128,23688,15768,5328,25056,28440  
    DW   6696,10080,29808,19368,11448,1008,20736,36216,2376,17856,32400,27144  
    DW   14040,8784,23328,31896,4968,13536,28080,22824,9720,4464,19008,34488,Lk4 ; c=48 
    DW   720,25344,35928,6984,17568,30096,26856,11736,8496,21024,31608,2664  
    DW   13248,32688,22536,14328,4176,23616,34200,5256,15840,28368,25128,10008  
    DW   6768,19296,29880,936,11520,36144,20808,17784,2448,27072,32472,8712  
    DW   14112,31824,23400,13464,5040,22752,28152,4392,9792,34416,19080,16056,Lk4 ; c=48 
    DW   792,6912,36000,30024,17640,11664,26928,20952,8568,2592,31680,32616  
    DW   13320,14256,22608,23544,4248,5184,34272,28296,15912,9936,25200,19224  
    DW   6840,864,29952,36072,11592,17712,20880,27000,2520,8640,32544,31752  
    DW   14184,13392,23472,22680,5112,4320,28224,34344,9864,15984,19152,25272,Lk4 ; c=48 
    DW   1152,35712,34632,17352,16272,26640,25560,8280,7200,31392,30312,13032  
    DW   11952,22320,21240,3960,2880,33984,32904,15624,14544,24912,23832,6552  
    DW   5472,29664,28584,11304,10224,20592,19512,2232,Lk4 ; c=32 
    DW   1224,17280,34704,26568,16344,8208,25632,31320,7272,12960,30384,22248  
    DW   12024,3888,21312,33912,2952,15552,32976,24840,14616,6480,23904,29592  
    DW   5544,11232,28656,20520,10296,2160,19584,35640,Lk4 ; c=32 
    DW   1296,26496,34776,8136,16416,31248,25704,12888,7344,22176,30456,3816  
    DW   12096,33840,21384,15480,3024,24768,33048,6408,14688,29520,23976,11160  
    DW   5616,20448,28728,2088,10368,35568,19656,17208,Lk4 ; c=32 
    DW   1368,8064,34848,31176,16488,12816,25776,22104,7416,3744,30528,33768  
    DW   12168,15408,21456,24696,3096,6336,33120,29448,14760,11088,24048,20376  
    DW   5688,2016,28800,35496,10440,17136,19728,26424,Lk4 ; c=32 
    DW   1440,31104,34920,12744,16560,22032,25848,3672,7488,33696,30600,15336  
    DW   12240,24624,21528,6264,3168,29376,33192,11016,14832,20304,24120,1944  
    DW   5760,35424,28872,17064,10512,26352,19800,7992,Lk4 ; c=32 
    DW   1512,12672,34992,21960,16632,3600,25920,33624,7560,15264,30672,24552  
    DW   12312,6192,21600,29304,3240,10944,33264,20232,14904,1872,24192,35352  
    DW   5832,16992,28944,26280,10584,7920,19872,31032,Lk4 ; c=32 
    DW   1584,21888,35064,3528,16704,33552,25992,15192,7632,24480,30744,6120  
    DW   12384,29232,21672,10872,3312,20160,33336,1800,14976,35280,24264,16920  
    DW   5904,26208,29016,7848,10656,30960,19944,12600,Lk4 ; c=32 
    DW   1656,3456,35136,33480,16776,15120,26064,24408,7704,6048,30816,29160  
    DW   12456,10800,21744,20088,3384,1728,33408,35208,15048,16848,24336,26136  
    DW   5976,7776,29088,30888,10728,12528,20016,21816,Lk4 ; c=32 
;
; Cycle structure and table for D = 256
;
; (0) c=1 
; (4,512,1020) c=3 
; (8,768,1012,260,504,520,764,12,256,1016,516,508) c=12 
; (16,896,996,388,488,648,748,140,240,784,884,276,376,536,636,28,128,1008,772,500,264,760,524,252) c=24 
; (20,384,1000,644,492,136,752,780,244,272,888,532,380,24,640,1004,132,496,776,756,268,248,528,892) c=24 
; (32,960,964,452,456,712,716,204,208,848,852,340,344,600,604,92,96,928,932,420,424,680,684,172,176,816,820,308,312,568,572,60,64,992,900,484,392,744,652,236,144,880,788,372,280,632,540,124) c=48 
; (36,448,968,708,460,200,720,844,212,336,856,596,348,88,608,924,100,416,936,676,428,168,688,812,180,304,824,564,316,56,576,988,68,480,904,740,396,232,656,876,148,368,792,628,284,120,544,956) c=48 
; (40,704,972,196,464,840,724,332,216,592,860,84,352,920,612,412,104,672,940,164,432,808,692,300,184,560,828,52,320,984,580,476,72,736,908,228,400,872,660,364,152,624,796,116,288,952,548,444) c=48 
; (44,192,976,836,468,328,728,588,220,80,864,916,356,408,616,668,108,160,944,804,436,296,696,556,188,48,832,980,324,472,584,732,76,224,912,868,404,360,664,620,156,112,800,948,292,440,552,700) c=48 
Tq8 DW   Lk4
    DW   0,Lk4 ; c=1 
    DW   144,18432,36720,Lk4 ; c=3 
    DW   288,27648,36432,9360,18144,18720,27504,432,9216,36576,18576,18288,Lk4 ; c=12 
    DW   576,32256,35856,13968,17568,23328,26928,5040,8640,28224,31824,9936  
    DW   13536,19296,22896,1008,4608,36288,27792,18000,9504,27360,18864,9072,Lk4 ; c=24 
    DW   720,13824,36000,23184,17712,4896,27072,28080,8784,9792,31968,19152  
    DW   13680,864,23040,36144,4752,17856,27936,27216,9648,8928,19008,32112,Lk4 ; c=24 
    DW   1152,34560,34704,16272,16416,25632,25776,7344,7488,30528,30672,12240  
    DW   12384,21600,21744,3312,3456,33408,33552,15120,15264,24480,24624,6192  
    DW   6336,29376,29520,11088,11232,20448,20592,2160,2304,35712,32400,17424  
    DW   14112,26784,23472,8496,5184,31680,28368,13392,10080,22752,19440,4464,Lk4 ; c=48 
    DW   1296,16128,34848,25488,16560,7200,25920,30384,7632,12096,30816,21456  
    DW   12528,3168,21888,33264,3600,14976,33696,24336,15408,6048,24768,29232  
    DW   6480,10944,29664,20304,11376,2016,20736,35568,2448,17280,32544,26640  
    DW   14256,8352,23616,31536,5328,13248,28512,22608,10224,4320,19584,34416,Lk4 ; c=48 
    DW   1440,25344,34992,7056,16704,30240,26064,11952,7776,21312,30960,3024  
    DW   12672,33120,22032,14832,3744,24192,33840,5904,15552,29088,24912,10800  
    DW   6624,20160,29808,1872,11520,35424,20880,17136,2592,26496,32688,8208  
    DW   14400,31392,23760,13104,5472,22464,28656,4176,10368,34272,19728,15984,Lk4 ; c=48 
    DW   1584,6912,35136,30096,16848,11808,26208,21168,7920,2880,31104,32976  
    DW   12816,14688,22176,24048,3888,5760,33984,28944,15696,10656,25056,20016  
    DW   6768,1728,29952,35280,11664,16992,21024,26352,2736,8064,32832,31248  
    DW   14544,12960,23904,22320,5616,4032,28800,34128,10512,15840,19872,25200,Lk4 ; c=48 
;
; Cycle structure and table for D = 128
;
; (0) c=1 
; (8,512,1016) c=3 
; (16,768,1000,264,496,528,760,24,256,1008,520,504) c=12 
; (32,896,968,392,464,656,728,152,224,800,872,296,368,560,632,56,128,992,776,488,272,752,536,248) c=24 
; (40,384,976,648,472,144,736,792,232,288,880,552,376,48,640,984,136,480,784,744,280,240,544,888) c=24 
; (64,960,904,456,400,720,664,216,160,864,808,360,304,624,568,120) c=16 
; (72,448,912,712,408,208,672,856,168,352,816,616,312,112,576,952) c=16 
; (80,704,920,200,416,848,680,344,176,608,824,104,320,944,584,440) c=16 
; (88,192,928,840,424,336,688,600,184,96,832,936,328,432,592,696) c=16 
Tq7 DW   Lk4
    DW   0,Lk4 ; c=1 
    DW   288,18432,36576,Lk4 ; c=3 
    DW   576,27648,36000,9504,17856,19008,27360,864,9216,36288,18720,18144,Lk4 ; c=12 
    DW   1152,32256,34848,14112,16704,23616,26208,5472,8064,28800,31392,10656  
    DW   13248,20160,22752,2016,4608,35712,27936,17568,9792,27072,19296,8928,Lk4 ; c=24 
    DW   1440,13824,35136,23328,16992,5184,26496,28512,8352,10368,31680,19872  
    DW   13536,1728,23040,35424,4896,17280,28224,26784,10080,8640,19584,31968,Lk4 ; c=24 
    DW   2304,34560,32544,16416,14400,25920,23904,7776,5760,31104,29088,12960  
    DW   10944,22464,20448,4320,Lk4 ; c=16 
    DW   2592,16128,32832,25632,14688,7488,24192,30816,6048,12672,29376,22176  
    DW   11232,4032,20736,34272,Lk4 ; c=16 
    DW   2880,25344,33120,7200,14976,30528,24480,12384,6336,21888,29664,3744  
    DW   11520,33984,21024,15840,Lk4 ; c=16 
    DW   3168,6912,33408,30240,15264,12096,24768,21600,6624,3456,29952,33696  
    DW   11808,15552,21312,25056,Lk4 ; c=16 
;
; Cycle structure and table for D = 64
;
; (0) c=1 
; (16,512,1008) c=3 
; (32,768,976,272,480,544,752,48,256,992,528,496) c=12 
; (64,896,912,400,416,672,688,176,192,832,848,336,352,608,624,112,128,960,784,464,288,736,560,240) c=24 
; (80,384,928,656,432,160,704,816,208,320,864,592,368,96,640,944,144,448,800,720,304,224,576,880) c=24 
Tq6 DW   Lk4
    DW   0,Lk4 ; c=1 
    DW   576,18432,36288,Lk4 ; c=3 
    DW   1152,27648,35136,9792,17280,19584,27072,1728,9216,35712,19008,17856,Lk4 ; c=12 
    DW   2304,32256,32832,14400,14976,24192,24768,6336,6912,29952,30528,12096  
    DW   12672,21888,22464,4032,4608,34560,28224,16704,10368,26496,20160,8640,Lk4 ; c=24 
    DW   2880,13824,33408,23616,15552,5760,25344,29376,7488,11520,31104,21312  
    DW   13248,3456,23040,33984,5184,16128,28800,25920,10944,8064,20736,31680,Lk4 ; c=24 
;
; Cycle structure and table for D = 32
;
; (0) c=1 
; (32,512,992) c=3 
; (64,768,928,288,448,576,736,96,256,960,544,480) c=12 
; (128,896,800,416,320,704,608,224) c=8 
; (160,384,832,672,352,192,640,864) c=8 
Tq5 DW   Lk4
    DW   0,Lk4 ; c=1 
    DW   1152,18432,35712,Lk4 ; c=3 
    DW   2304,27648,33408,10368,16128,20736,26496,3456,9216,34560,19584,17280,Lk4 ; c=12 
    DW   4608,32256,28800,14976,11520,25344,21888,8064,Lk4 ; c=8 
    DW   5760,13824,29952,24192,12672,6912,23040,31104,Lk4 ; c=8 
;
; Cycle structure and table for D = 16
;
; (0) c=1 
; (64,512,960) c=3 
; (128, 768,832,320,384,640,704,192,256,896,576,448) c=12 
Tq4 DW   Lk4
    DW   0,Lk4 ; c=1 
    DW   2304,18432,34560,Lk4 ; c=3 
    DW   4608,27648,29952,11520,13824,23040,25344,6912,9216,32256,20736,16128,Lk4 ; c=12 
;
; Cycle structure and table for D = 8
;
; (0) c=1 
; (128,512,896) c=3 
; (256,768,640,384) c=4 
Tq3 DW   Lk4
    DW   0,Lk4 ; c=1 
    DW   4608,18432,32256,Lk4 ; c=3 
    DW   9216,27648,23040,13824,Lk4 ; c=4 
;
_DATA   ends
;
_TEXT    segment dword public 'CODE'
         assume  CS:_TEXT
         assume  DS:DGROUP
_AR2F80A proc    near
;========================================
;
; initialisation
         public xsqufft80_
         extrn  xsqu_:NEAR
xsqufft80_:
;
;========================================
;
; a => a^2 by Finite Fourier Transform
;
; Choose FFT dimension or traditional method
;
; EDX = number of digits
;
         CMP    EDX,45
         JBE    xsqu_
         MOV    ZGlgD,5     ; FFT dim 2^5 = 32
         CMP    EDX,60
         JBE    Xfft 
         CMP    EDX,90
         JBE    xsqu_
         MOV    ZGlgD,6
         CMP    EDX,120
         JBE    Xfft
         MOV    ZGlgD,7
         CMP    EDX,240
         JBE    Xfft
         MOV    ZGlgD,8
         CMP    EDX,480
         JBE    Xfft
         MOV    ZGlgD,9
         CMP    EDX,960
         JBE    Xfft
         MOV    ZGlgD,10
         CMP    EDX,1920
         JA     xsqu_       ; More than 1920 digits
;
; Save registers
Xfft:    mov    Zcx,ECX
         mov    Zbp,EBP
         mov    Zsi,ESI
         mov    Zdi,EDI
         mov    ZYptr,EAX            ; &a
         mov    ZXptr,EBX            ; &f (fft array)
;
; Clear high order digits
         lea    EDI,[EAX+EDX*4]      ; First high order digit
         lea    ESI,[EAX+EDX*8]      ; Limit
Xfft1:   cmp    EDI,ESI
         jae    Xfft2
         mov    dword ptr [EDI],0
         lea    EDI,4[EDI]
         jmp    Xfft1
;
; Set up FFT parameters
Xfft2:   MOV    ECX,ZGlgD
         MOV    EAX,1
         SHL    EAX,CL
         MOV    ZGDim,EAX   ; Dimension
         NEG    ECX
         ADD    ECX,10
         MOV    EAX,LnF
         SHL    EAX,CL
         MOV    ZGLbF,EAX   ; LnF*1024/D
;
; First Fast Fourier Transform 
         CALL   XfftI       ; D/2 and D/4
         MOV    EAX,ZGDim
         SHR    EAX,3       ; D/8
         MOV    ZFd,EAX
         MOV    ZFb,128
         MOV    ZFI,128*LnF
         MOV    ZGe,4
Xfft4:   MOV    EAX,ZGe
         MOV    ZFe,EAX
         CALL   XfftA
         SHL    ZGe,1
         SHR    ZFI,1
         SHR    ZFb,1
         SHR    ZFd,1
         JNZ    Xfft4
;
; Reduce (mod F)
         CALL   XfftR
;
; X(i)^2 and permute X(i) <=> X(D - i)
         CALL   XfftQ
;
; Second Fast Fourier Transform 
         MOV    EAX,ZGDim
         SHR    EAX,1       ; D/2
         MOV    ZFd,EAX
         MOV    ZFb,512
         MOV    ZFI,512*LnF
         MOV    ZGe,1
Xfft6:   MOV    EAX,ZGe
         MOV    ZFe,EAX
         CALL   XfftA
         SHL    ZGe,1
         SHR    ZFI,1
         SHR    ZFb,1
         SHR    ZFd,1
         JNZ    Xfft6
;
; Reduce (mod F) such that X(i) = 0 (mod D) 
         CALL   XfftS
;
; y = X/D,  X(i) < D^2/2 M^2, i = 0, 1, ..., D-2,  X(D-1) = 0
;
; HHHHGGGGFFFFEEEEDDDDCCCCBBBBAAAA000ihhhhggggffffeeeeddddccccbbbbaaaa
; MOV Y,X+1                       0000ihhhhggggffffeeeeddddccccbbbbaaa
;                                   eeeeddddccccbbbbaaaa    ADD/ADC
;                   000ihhhhggggffff                        ADC 0, MOV
;                    eeeeddddccccbbbbaaaa                   ADD/ADC
;    000ihhhhggggffff                                       ADC 0, MOV
;
         MOV    ECX,ZGlgD
         mov    ESI,ZXptr
         mov    EDI,ZYptr
         MOV    EAX,0[ESI]
         MOV    EDX,4[ESI]
         SHRD   EAX,EDX,CL
         MOV    0[EDI],EAX
         MOV    EAX,8[ESI]
         SHRD   EDX,EAX,CL
         MOV    4[EDI],EDX
         MOV    EDX,12[ESI]
         SHRD   EAX,EDX,CL
         MOV    8[EDI],EAX
         MOV    EAX,16[ESI]
         SHRD   EDX,EAX,CL
         MOV    12[EDI],EDX
         MOV    EDX,20[ESI]
         SHRD   EAX,EDX,CL
         MOV    16[EDI],EAX
         MOV    EAX,24[ESI]
         SHRD   EDX,EAX,CL
         MOV    20[EDI],EDX
         MOV    EDX,28[ESI]
         SHRD   EAX,EDX,CL
         MOV    24[EDI],EAX
         MOV    EAX,32[ESI]
         SHRD   EDX,EAX,CL
         MOV    28[EDI],EDX
         MOV    dword ptr 32[EDI],0
         add    EDI,LnM
         MOV    EBX,2
         MOV    EBP,ZGDim
         SUB    EBP,2
Xfft8:   MOV    SI,Tb[EBX]
         AND    ESI,0FFFFh
         add    ESI,ZXptr
         MOV    EAX,0[ESI]
         MOV    EDX,4[ESI]
         SHRD   EAX,EDX,CL
         MOV    ZU+0,EAX
         MOV    EAX,8[ESI]
         SHRD   EDX,EAX,CL
         MOV    ZU+4,EDX
         MOV    EDX,12[ESI]
         SHRD   EAX,EDX,CL
         MOV    ZU+8,EAX
         MOV    EAX,16[ESI]
         SHRD   EDX,EAX,CL
         MOV    ZU+12,EDX
         MOV    EDX,20[ESI]
         SHRD   EAX,EDX,CL
         MOV    ZU+16,EAX
         MOV    EAX,24[ESI]
         SHRD   EDX,EAX,CL
         MOV    ZU+20,EDX
         MOV    EDX,28[ESI]
         SHRD   EAX,EDX,CL
         MOV    ZU+24,EAX
         MOV    EAX,32[ESI]
         SHRD   EDX,EAX,CL
         MOV    ZU+28,EDX
         MOV    EAX,ZU+0
         ADD    0[EDI],EAX
         MOV    EAX,ZU+4
         ADC    4[EDI],EAX
         MOV    EAX,ZU+8
         ADC    8[EDI],EAX
         MOV    EAX,ZU+12
         ADC    12[EDI],EAX
         MOV    EAX,ZU+16
         ADC    16[EDI],EAX
         MOV    EAX,ZU+20
         ADC    EAX,0
         MOV    20[EDI],EAX
         MOV    EAX,ZU+24
         ADC    EAX,0
         MOV    24[EDI],EAX
         MOV    EAX,ZU+28
         ADC    EAX,0
         MOV    28[EDI],EAX
         MOV    dword ptr 32[EDI],0
         ADD    EDI,LnM
         ADD    EBX,2
         DEC    EBP
         JNZ    Xfft8
;
Xfft9:   mov    EDI,Zdi
         mov    ESI,Zsi
         mov    EBP,Zbp
         mov    ECX,Zcx
         retn   
;========================================
; FFT special first step: y => X, d = D/4
;
; X(D/4,0,i) = y(i) +         y(i+D/4)
; X(D/4,1,i) = y(i) + G^(D/4) y(i+D/4)
; X(D/4,2,i) = y(i) -         y(i+D/4)
; X(D/4,3,i) = y(i) - G^(D/4) y(i+D/4)
;
; i = 0, 1, ..., D/4 - 1
;
; 0 <= y(i) < M
; G^(D/4) = (F-1)/2
;
XfftI:   mov    ESI,ZYptr
         mov    EDI,ZXptr
         MOV    EBX,LnM
         MOV    ECX,ZGlgD
         SUB    ECX,2
         SHL    EBX,CL    ; D/4*LnM
         add    EBX,ESI
;
; Pick up high order words
XfftId:  MOV    EBP,12[ESI]
         AND    EBP,00FFFFFFh
         MOV    ECX,EBP
         MOV    EDX,12[EBX]
         AND    EDX,00FFFFFFh
;
; Subtract  y(i+D/4)  from  X(D/4,2,i)
; -M < X(D/4,2,i) < M
         MOV    EAX,0[ESI]
         MOV    0+Lk3[EDI],EAX
         SUB    EAX,0[EBX]
         MOV    0+Lk1[EDI],EAX
         MOV    EAX,4[ESI]
         MOV    4+Lk3[EDI],EAX
         SBB    EAX,4[EBX]
         MOV    4+Lk1[EDI],EAX
         MOV    EAX,8[ESI]
         MOV    8+Lk3[EDI],EAX
         SBB    EAX,8[EBX]
         MOV    8+Lk1[EDI],EAX
         MOV    12+Lk3[EDI],ECX
         SBB    EBP,EDX
         MOV    12+Lk1[EDI],EBP
         MOV    EAX,0
         SBB    EAX,0
         MOV    16+Lk1[EDI],EAX
         MOV    20+Lk1[EDI],EAX
         MOV    24+Lk1[EDI],EAX
         MOV    28+Lk1[EDI],EAX
         MOV    32+Lk1[EDI],EAX
;
; Subtract  G^(D/4) y(i+D/4)  from  X(D/4,3,i)
; -M(F-1)/2 < X(D/4,3,i) < M
         MOV    EAX,0
         SUB    EAX,0[EBX]
         MOV    16+Lk3[EDI],EAX
         MOV    EAX,0
         SBB    EAX,4[EBX]
         MOV    20+Lk3[EDI],EAX
         MOV    EAX,0
         SBB    EAX,8[EBX]
         MOV    24+Lk3[EDI],EAX
         MOV    EAX,0
         SBB    EAX,EDX
         MOV    28+Lk3[EDI],EAX
         MOV    EAX,0
         SBB    EAX,0
         MOV    32+Lk3[EDI],EAX
;
; Add          y(i+D/4)  to  X(D/4,0,i)
; Add  G^(D/4) y(i+D/4)  to  X(D/4,1,i)
; 0 <= X(D/4,0,i) < 2M
; 0 <= X(D/4,1,i) < M(F-1)/2
         MOV    EAX,0[ESI]
         MOV    EBP,0[EBX]
         MOV    0+Lk2[EDI],EAX
         MOV    16+Lk2[EDI],EBP
         ADD    EAX,EBP
         MOV    0+Lk0[EDI],EAX
         MOV    dword ptr 16+Lk0[EDI],0
         MOV    EAX,4[ESI]
         MOV    EBP,4[EBX]
         MOV    4+Lk2[EDI],EAX
         MOV    20+Lk2[EDI],EBP
         ADC    EAX,EBP
         MOV    4+Lk0[EDI],EAX
         MOV    dword ptr 20+Lk0[EDI],0
         MOV    EAX,8[ESI]
         MOV    EBP,8[EBX]
         MOV    8+Lk2[EDI],EAX
         MOV    24+Lk2[EDI],EBP
         ADC    EAX,EBP
         MOV    8+Lk0[EDI],EAX
         MOV    dword ptr 24+Lk0[EDI],0
         MOV    12+Lk2[EDI],ECX
         MOV    28+Lk2[EDI],EDX
         ADC    ECX,EDX
         MOV    12+Lk0[EDI],ECX
         MOV    dword ptr 28+Lk0[EDI],0
         MOV    dword ptr 32+Lk0[EDI],0
         MOV    dword ptr 32+Lk2[EDI],0
; Next i
         mov    EAX,ZXptr
         ADD    EDI,ZGLbF
         add    EAX,256*LnF
         ADD    ESI,LnM  
         ADD    EBX,LnM
         CMP    EDI,EAX
         jb     XfftId
         RETN
;====================================================
; FFT general step
;
; X(d,k,i)   = X(2d,k,i) + G^(kd) X(2d,k,i+d)
; X(d,k+e,i) = X(2d,k,i) - G^(kd) X(2d,k,i+d)
;
; k = 0, ..., e-1,  i = 0, ..., d-1
;
; ZFd = d,          ZFe = e, 
; ZFb = d*1024/D,   ZFI = offset to X(2d,k,i+d)
;
XfftA:   MOV    ZF2k,0         ; 2k
         XOR    EDX,EDX        ; kd
XfftAb:  MOV    EDI,ZF2k
         MOV    ZU+0,0         ; Clear low-order U
         MOV    DI,Tb[EDI]
         MOV    ZU+4,0
         and    EDI,0FFFFh
         MOV    ZU+8,0
         add    EDI,ZXptr
         MOV    ZU+12,0
         MOV    EBX,EDX
         MOV    ZU+16,0
         SHR    EBX,4          ; EBX = [kd/16]
         MOV    ZU+20,0
         MOV    ZU+24,0
         MOV    ZU+28,0
         MOV    ECX,ZFd        ; i  = 0, ..., d-1
;
XfftAd:  MOV    ESI,ZFI
         ADD    ESI,EDI        ; ESI -> X(2d,k,i+d)
; Clear high-order U
         MOV    EAX,32[ESI]
         SAR    EAX,31
         MOV    ZU+36,EAX
         MOV    ZU+40,EAX
         MOV    ZU+44,EAX
         MOV    ZU+48,EAX
         MOV    ZU+52,EAX
         MOV    ZU+56,EAX
         MOV    ZU+60,EAX
         MOV    ZU+64,EAX
         TEST   EDX,15
         JNZ    XfftAshf
; U = G^kd X(2d,k,i+d),  kd = 0 (mod 16)
         MOV    EAX,0[ESI]
         MOV    ZU+0[EBX],EAX
         MOV    EAX,4[ESI]
         MOV    ZU+4[EBX],EAX
         MOV    EAX,8[ESI]
         MOV    ZU+8[EBX],EAX
         MOV    EAX,12[ESI]
         MOV    ZU+12[EBX],EAX
         MOV    EAX,16[ESI]
         MOV    ZU+16[EBX],EAX
         MOV    EAX,20[ESI]
         MOV    ZU+20[EBX],EAX
         MOV    EAX,24[ESI]
         MOV    ZU+24[EBX],EAX
         MOV    EAX,28[ESI]
         MOV    ZU+28[EBX],EAX
         MOV    EAX,32[ESI]
         MOV    ZU+32[EBX],EAX
XfftAshfret:
; Reduce G^kd X(2d,k,i+d)
         MOV    EAX,ZU+0
         SUB    EAX,ZU+32
         MOV    ZW+0,EAX
         MOV    EAX,ZU+4
         SBB    EAX,ZU+36
         MOV    ZW+4,EAX
         MOV    EAX,ZU+8
         SBB    EAX,ZU+40
         MOV    ZW+8,EAX
         MOV    EAX,ZU+12
         SBB    EAX,ZU+44
         MOV    ZW+12,EAX
         MOV    EAX,ZU+16
         SBB    EAX,ZU+48
         MOV    ZW+16,EAX
         MOV    EAX,ZU+20
         SBB    EAX,ZU+52
         MOV    ZW+20,EAX
         MOV    EAX,ZU+24
         SBB    EAX,ZU+56
         MOV    ZW+24,EAX
         MOV    EAX,ZU+28
         SBB    EAX,ZU+60
         MOV    ZW+28,EAX
         MOV    EAX,0
         SBB    EAX,ZU+64
         MOV    ZW+32,EAX
XfftAoddret:
; X(d,k+e,i) = X(2d,k,i) - G^kd X(2d,k,i+d)
         MOV    EAX,0[EDI]
         SUB    EAX,ZW+0
         MOV    0[ESI],EAX
         MOV    EAX,4[EDI]
         SBB    EAX,ZW+4
         MOV    4[ESI],EAX
         MOV    EAX,8[EDI]
         SBB    EAX,ZW+8
         MOV    8[ESI],EAX
         MOV    EAX,12[EDI]
         SBB    EAX,ZW+12
         MOV    12[ESI],EAX
         MOV    EAX,16[EDI]
         SBB    EAX,ZW+16
         MOV    16[ESI],EAX
         MOV    EAX,20[EDI]
         SBB    EAX,ZW+20
         MOV    20[ESI],EAX
         MOV    EAX,24[EDI]
         SBB    EAX,ZW+24
         MOV    24[ESI],EAX
         MOV    EAX,28[EDI]
         SBB    EAX,ZW+28
         MOV    28[ESI],EAX
         MOV    EAX,32[EDI]
         SBB    EAX,ZW+32
         MOV    32[ESI],EAX
; X(d,k,i) = X(2d,k,i) + G^kd X(2d,k,i+d)
         MOV    EAX,ZW+0
         ADD    0[EDI],EAX
         MOV    EAX,ZW+4
         ADC    4[EDI],EAX
         MOV    EAX,ZW+8
         ADC    8[EDI],EAX
         MOV    EAX,ZW+12
         ADC    12[EDI],EAX
         MOV    EAX,ZW+16
         ADC    16[EDI],EAX
         MOV    EAX,ZW+20
         ADC    20[EDI],EAX
         MOV    EAX,ZW+24
         ADC    24[EDI],EAX
         MOV    EAX,ZW+28
         ADC    28[EDI],EAX
         MOV    EAX,ZW+32
         ADC    32[EDI],EAX
; Next i
         ADD    EDI,ZGLbF
         DEC    ECX
         JNZ    XfftAd
; Next k
         ADD    ZF2k,2
         ADD    EDX,ZFb
         DEC    ZFe
         JNZ    XfftAb
         RETN
;
; U = G^kd X(2d,k,i+d),  kd > 0 (mod 16)
XfftAshf:
         MOV    ZFkd,EDX
         MOV    ZFkc,ECX
         MOV    CL,DL
         AND    CL,14
         SHR    CL,1
         MOV    EAX,32[ESI]
;
         MOV    EDX,28[ESI]
         SHLD   EAX,EDX,CL
         MOV    ZU+32[EBX],EAX
         MOV    EAX,24[ESI]
         SHLD   EDX,EAX,CL
         MOV    ZU+28[EBX],EDX
;
         MOV    EDX,20[ESI]
         SHLD   EAX,EDX,CL
         MOV    ZU+24[EBX],EAX
         MOV    EAX,16[ESI]
         SHLD   EDX,EAX,CL
         MOV    ZU+20[EBX],EDX
;
         MOV    EDX,12[ESI]
         SHLD   EAX,EDX,CL
         MOV    ZU+16[EBX],EAX
         MOV    EAX,8[ESI]
         SHLD   EDX,EAX,CL
         MOV    ZU+12[EBX],EDX
;
         MOV    EDX,4[ESI]
         SHLD   EAX,EDX,CL
         MOV    ZU+8[EBX],EAX
         MOV    EAX,0[ESI]
         SHLD   EDX,EAX,CL
         MOV    ZU+4[EBX],EDX
;
         SHL    EAX,CL
         MOV    ZU+0[EBX],EAX
         TEST   ZFkd,1
         JNZ    XfftAodd
         MOV    ECX,ZFkc
         MOV    EDX,ZFkd
         JMP    XfftAshfret
;
; W = U*(2^192 - 2^64),  kd = 1 (mod 16)
;
;  0:          -  8 + 24 + 40 - 56
;  4:          - 12 + 28 + 44 - 60
;  8:     -  0 - 16 + 32 + 48 - 64
; 12:     -  4 - 20 + 36 + 52
; 16:     -  8 - 24 + 40 + 56
; 20:     - 12 - 28 + 44 + 60
; 24: + 0 - 16 - 32 + 48 + 64
; 28: + 4 - 20 - 36 + 52
;
XfftAodd:
         MOV    EDX,ZU+64
         SAR    EDX,31       ; Sign
         MOV    ECX,0        ; Carry
;
         MOV    EAX,ZU+24
         SUB    EAX,ZU+8
         MOV    ZW+0,EAX
         MOV    EAX,ZU+28
         SBB    EAX,ZU+12
         MOV    ZW+4,EAX
         MOV    EAX,ZU+32
         SBB    EAX,ZU+16
         MOV    ZW+8,EAX
         MOV    EAX,ZU+36
         SBB    EAX,ZU+20
         MOV    ZW+12,EAX
         MOV    EAX,ZU+40
         SBB    EAX,ZU+24
         MOV    ZW+16,EAX
         MOV    EAX,ZU+44
         SBB    EAX,ZU+28
         MOV    ZW+20,EAX
         MOV    EAX,ZU+48
         SBB    EAX,ZU+32
         MOV    ZW+24,EAX
         MOV    EAX,ZU+52
         SBB    EAX,ZU+36
         MOV    ZW+28,EAX
         SBB    ECX,0
;
         MOV    EAX,ZU+0
         ADD    ZW+24,EAX
         MOV    EAX,ZU+4
         ADC    ZW+28,EAX
         ADC    ECX,0
;
         MOV    EAX,ZU+0
         SUB    ZW+8,EAX
         MOV    EAX,ZU+4
         SBB    ZW+12,EAX
         MOV    EAX,ZU+8
         SBB    ZW+16,EAX
         MOV    EAX,ZU+12
         SBB    ZW+20,EAX
         MOV    EAX,ZU+16
         SBB    ZW+24,EAX
         MOV    EAX,ZU+20
         SBB    ZW+28,EAX
         SBB    ECX,0
;
         MOV    EAX,ZU+56
         SUB    ZW+0,EAX
         MOV    EAX,ZU+60
         SBB    ZW+4,EAX
         MOV    EAX,ZU+64
         SBB    ZW+8,EAX
         SBB    ZW+12,EDX
         SBB    ZW+16,EDX
         SBB    ZW+20,EDX
         SBB    ZW+24,EDX
         SBB    ZW+28,EDX
         SBB    ECX,EDX
;
         MOV    EAX,ZU+40
         ADD    ZW+0,EAX
         MOV    EAX,ZU+44
         ADC    ZW+4,EAX
         MOV    EAX,ZU+48
         ADC    ZW+8,EAX
         MOV    EAX,ZU+52
         ADC    ZW+12,EAX
         MOV    EAX,ZU+56
         ADC    ZW+16,EAX
         MOV    EAX,ZU+60
         ADC    ZW+20,EAX
         MOV    EAX,ZU+64
         ADC    ZW+24,EAX
         ADC    ZW+28,EDX
         ADC    ECX,EDX
;
         MOV    ZW+32,ECX
         MOV    ECX,ZFkc
         MOV    EDX,ZFkd
         JMP    XfftAoddret
;====================================================
; Reduce X(i) modulo F, i = 0, 1, ..., D-1
;
; Before:  -2^287 < X(i) < 2^287
; After:   0 <= X(i) <= 2^256  
;
; Let X = X(i) = A + 2^256 B
;
; If X >= 0 then X = A - B (mod F)
;           If A - B < 0 then add F
;
; If X <  0 then X = A + 2^256 B - 2^288
;                  = A + 2^32 - B (mod F)
;
XfftR:   MOV    EDI,ZXptr
         MOV    ECX,ZGDim
;
XfftRb:  MOV    EAX,32[EDI]
         CMP    EAX,0
         JE     XfftRx
         MOV    dword ptr 32+[EDI],0
         JL     XfftRn
; X(i) >= 0
         SUB    0[EDI],EAX
         SBB    dword ptr 4[EDI],0
         JNC    XfftRx
         SBB    dword ptr 8[EDI],0
         JNC    XfftRx
         SBB    dword ptr 12[EDI],0
         JNC    XfftRx
         SBB    dword ptr 16[EDI],0
         JNC    XfftRx
         SBB    dword ptr 20[EDI],0
         JNC    XfftRx
         SBB    dword ptr 24[EDI],0
         JNC    XfftRx
         SBB    dword ptr 28[EDI],0
         JNC    XfftRx
         ADC    dword ptr 0[EDI],0
         JNC    XfftRx
         ADC    dword ptr 4[EDI],0
         JNC    XfftRx
XfftRg:  ADC    dword ptr 8[EDI],0
         JNC    XfftRx
         ADC    dword ptr 12[EDI],0
         JNC    XfftRx
         ADC    dword ptr 16[EDI],0
         JNC    XfftRx
         ADC    dword ptr 20[EDI],0
         JNC    XfftRx
         ADC    dword ptr 24[EDI],0
         JNC    XfftRx
         ADC    dword ptr 28[EDI],0
         JNC    XfftRx
; Must be  a + 2^256,  a < 2^32 
         ADC    dword ptr 32[EDI],0
         TEST   dword ptr 0[EDI],0FFFFFFFFh
         JZ     XfftRx
         DEC    dword ptr 0[EDI]
         MOV    dword ptr 32[EDI],0
         JMP    XfftRx
; X(i) < 0
XfftRn:  SUB    0[EDI],EAX
         JC     XfftRx
         ADD    dword ptr 4[EDI],1
         JC     XfftRg
;
XfftRx:  ADD    EDI,ZGLbF
         DEC    ECX
         JNZ    XfftRb
         RETN
;====================================================
; Determine X(i) from X(i) modulo F and D, 
; i = 0, 1, ..., D-2
;
; Before:  -2^287 < X(i) < 2^287
; After:   0 <= X(i) <= D*2^256, D|X(i)  
;
; As XfftR, but must add  cF  if  X(i) = -c (mod D)
;
XfftS:   MOV    EDI,ZXptr
         MOV    ECX,ZGDim
         DEC    ECX
;
XfftSb:  MOV    EAX,32[EDI]
         CMP    EAX,0
         JE     XfftSt
         MOV    dword ptr 32+[EDI],0
         JL     XfftSn
; X(i) >= 0
         SUB    0[EDI],EAX
         SBB    dword ptr 4[EDI],0
         JNC    XfftSt
         SBB    dword ptr 8[EDI],0
         JNC    XfftSt
         SBB    dword ptr 12[EDI],0
         JNC    XfftSt
         SBB    dword ptr 16[EDI],0
         JNC    XfftSt
         SBB    dword ptr 20[EDI],0
         JNC    XfftSt
         SBB    dword ptr 24[EDI],0
         JNC    XfftSt
         SBB    dword ptr 28[EDI],0
         JNC    XfftSt
         ADC    dword ptr 0[EDI],0
         JNC    XfftSt
         ADC    dword ptr 4[EDI],0
         JNC    XfftSt
XfftSg:  ADC    dword ptr 8[EDI],0
         JNC    XfftSt
         ADC    dword ptr 12[EDI],0
         JNC    XfftSt
         ADC    dword ptr 16[EDI],0
         JNC    XfftSt
         ADC    dword ptr 20[EDI],0
         JNC    XfftSt
         ADC    dword ptr 24[EDI],0
         JNC    XfftSt
         ADC    dword ptr 28[EDI],0
         JNC    XfftSt
; Must be  a + 2^256,  a < 2^32 
         ADC    dword ptr 32[EDI],0
         TEST   dword ptr 0[EDI],0FFFFFFFFh
         JZ     XfftSt
         DEC    dword ptr 0[EDI]
         MOV    dword ptr 32[EDI],0
         JMP    XfftSt
; X(i) < 0
XfftSn:  SUB    0[EDI],EAX
         JC     XfftSt
         ADD    dword ptr 4[EDI],1
         JC     XfftSg
;
XfftSt:  MOV    EAX,0[EDI]
         MOV    EDX,ZGDim
         DEC    EDX           ; D - 1
         AND    EAX,EDX
         JZ     XfftSx
         NEG    EAX
         ADC    EAX,EDX       ; D - X
         ADD    32[EDI],EAX
         ADD    0[EDI],EAX
         ADC    dword ptr 4[EDI],0
         JNC    XfftSx
         ADC    dword ptr 8[EDI],0
         JNC    XfftSx
         ADC    dword ptr 12[EDI],0
         JNC    XfftSx
         ADC    dword ptr 16[EDI],0
         JNC    XfftSx
         ADC    dword ptr 20[EDI],0
         JNC    XfftSx
         ADC    dword ptr 24[EDI],0
         ADC    dword ptr 28[EDI],0
         ADC    dword ptr 32[EDI],0
XfftSx:  ADD    EDI,ZGLbF
         DEC    ECX
         JNZ    XfftSb
         RETN
;====================================================
; X(i) => X(i)^2
;
; 0 <= X(i) <= 2^256
; ZX[SI] -> X(i),  ZX[DI] -> X(i)^2
;
; Get correct control table parameters
XfftQ:   MOV    EBX,11
         SUB    EBX,ZGlgD       ; 11 - log2 D
         MOV    EAX,ZStab[EBX*8]
         lea    EAX,TqA[EAX]
         MOV    ZStab,EAX       ; Table address
         MOV    EAX,ZSind[EBX*8]
         MOV    ZSind,EAX       ; index
;
; Do an element
XfftQe:  MOV    EBX,ZStab
         ADD    EBX,ZSind
         MOV    DI,0[EBX]
         MOV    SI,-2[EBX]
         mov    EAX,ZXptr
         AND    EDI,0FFFFh
         AND    ESI,0FFFFh
         CMP    EDI,Lk4
         lea    EDI,[EDI+EAX]
         lea    ESI,[ESI+EAX]
         JE     XfftQs
         TEST   BYTE PTR[32+ESI],1
         JNZ    XfftQu
;
; X(i)^2 modulo 2^256 + 1
;-1  0  7 
  MOV  EAX,0[ESI]
  MOV  EDX,28[ESI]
  MOV  ECX,0
  MOV  EBX,0
  MUL  EDX
  MOV  EBP,EAX
  SUB  ECX,EDX
  SBB  EBX,0
  ADD  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
;-1  1  6 
  MOV  EAX,4[ESI]
  MOV  EDX,24[ESI]
  MUL  EDX
  ADD  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
  ADD  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
;-1  2  5 
  MOV  EAX,8[ESI]
  MOV  EDX,20[ESI]
  MUL  EDX
  ADD  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
  ADD  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
;-1  3  4 
  MOV  EAX,12[ESI]
  MOV  EDX,16[ESI]
  MUL  EDX
  ADD  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
  ADD  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
  MOV  ZW,EBP
; 0  0  0 
  MOV  EAX,0[ESI]
  MOV  EBP,EBX
  SAR  EBP,31
  MUL  EAX
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
; 0  7  1 
  MOV  EAX,28[ESI]
  MOV  EDX,4[ESI]
  MUL  EDX
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
; 0  6  2 
  MOV  EAX,24[ESI]
  MOV  EDX,8[ESI]
  MUL  EDX
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
; 0  5  3 
  MOV  EAX,20[ESI]
  MOV  EDX,12[ESI]
  MUL  EDX
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
; 0  4  4 
  MOV  EAX,16[ESI]
  MUL  EAX
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
  MOV  0 [EDI],ECX
; 1  0  1 
  MOV  EAX,0[ESI]
  MOV  EDX,4[ESI]
  MOV  ECX,EBP
  SAR  ECX,31
  MUL  EDX
  ADD  EBX,EAX
  ADC  EBP,EDX
  ADC  ECX,0
  ADD  EBX,EAX
  ADC  EBP,EDX
  ADC  ECX,0
; 1  7  2 
  MOV  EAX,28[ESI]
  MOV  EDX,8[ESI]
  MUL  EDX
  SUB  EBX,EAX
  SBB  EBP,EDX
  SBB  ECX,0
  SUB  EBX,EAX
  SBB  EBP,EDX
  SBB  ECX,0
; 1  6  3 
  MOV  EAX,24[ESI]
  MOV  EDX,12[ESI]
  MUL  EDX
  SUB  EBX,EAX
  SBB  EBP,EDX
  SBB  ECX,0
  SUB  EBX,EAX
  SBB  EBP,EDX
  SBB  ECX,0
; 1  5  4 
  MOV  EAX,20[ESI]
  MOV  EDX,16[ESI]
  MUL  EDX
  SUB  EBX,EAX
  SBB  EBP,EDX
  SBB  ECX,0
  SUB  EBX,EAX
  SBB  EBP,EDX
  SBB  ECX,0
  MOV  4 [EDI],EBX
; 2  0  2 
  MOV  EAX,0[ESI]
  MOV  EDX,8[ESI]
  MOV  EBX,ECX
  SAR  EBX,31
  MUL  EDX
  ADD  EBP,EAX
  ADC  ECX,EDX
  ADC  EBX,0
  ADD  EBP,EAX
  ADC  ECX,EDX
  ADC  EBX,0
; 2  1  1 
  MOV  EAX,4[ESI]
  MUL  EAX
  ADD  EBP,EAX
  ADC  ECX,EDX
  ADC  EBX,0
; 2  7  3 
  MOV  EAX,28[ESI]
  MOV  EDX,12[ESI]
  MUL  EDX
  SUB  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
  SUB  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
; 2  6  4 
  MOV  EAX,24[ESI]
  MOV  EDX,16[ESI]
  MUL  EDX
  SUB  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
  SUB  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
; 2  5  5 
  MOV  EAX,20[ESI]
  MUL  EAX
  SUB  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
  MOV  8 [EDI],EBP
; 3  0  3 
  MOV  EAX,0[ESI]
  MOV  EDX,12[ESI]
  MOV  EBP,EBX
  SAR  EBP,31
  MUL  EDX
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
; 3  1  2 
  MOV  EAX,4[ESI]
  MOV  EDX,8[ESI]
  MUL  EDX
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
; 3  7  4 
  MOV  EAX,28[ESI]
  MOV  EDX,16[ESI]
  MUL  EDX
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
; 3  6  5 
  MOV  EAX,24[ESI]
  MOV  EDX,20[ESI]
  MUL  EDX
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
  MOV  12 [EDI],ECX
; 4  0  4 
  MOV  EAX,0[ESI]
  MOV  EDX,16[ESI]
  MOV  ECX,EBP
  SAR  ECX,31
  MUL  EDX
  ADD  EBX,EAX
  ADC  EBP,EDX
  ADC  ECX,0
  ADD  EBX,EAX
  ADC  EBP,EDX
  ADC  ECX,0
; 4  1  3 
  MOV  EAX,4[ESI]
  MOV  EDX,12[ESI]
  MUL  EDX
  ADD  EBX,EAX
  ADC  EBP,EDX
  ADC  ECX,0
  ADD  EBX,EAX
  ADC  EBP,EDX
  ADC  ECX,0
; 4  2  2 
  MOV  EAX,8[ESI]
  MUL  EAX
  ADD  EBX,EAX
  ADC  EBP,EDX
  ADC  ECX,0
; 4  7  5 
  MOV  EAX,28[ESI]
  MOV  EDX,20[ESI]
  MUL  EDX
  SUB  EBX,EAX
  SBB  EBP,EDX
  SBB  ECX,0
  SUB  EBX,EAX
  SBB  EBP,EDX
  SBB  ECX,0
; 4  6  6 
  MOV  EAX,24[ESI]
  MUL  EAX
  SUB  EBX,EAX
  SBB  EBP,EDX
  SBB  ECX,0
  MOV  16 [EDI],EBX
; 5  0  5 
  MOV  EAX,0[ESI]
  MOV  EDX,20[ESI]
  MOV  EBX,ECX
  SAR  EBX,31
  MUL  EDX
  ADD  EBP,EAX
  ADC  ECX,EDX
  ADC  EBX,0
  ADD  EBP,EAX
  ADC  ECX,EDX
  ADC  EBX,0
; 5  1  4 
  MOV  EAX,4[ESI]
  MOV  EDX,16[ESI]
  MUL  EDX
  ADD  EBP,EAX
  ADC  ECX,EDX
  ADC  EBX,0
  ADD  EBP,EAX
  ADC  ECX,EDX
  ADC  EBX,0
; 5  2  3 
  MOV  EAX,8[ESI]
  MOV  EDX,12[ESI]
  MUL  EDX
  ADD  EBP,EAX
  ADC  ECX,EDX
  ADC  EBX,0
  ADD  EBP,EAX
  ADC  ECX,EDX
  ADC  EBX,0
; 5  7  6 
  MOV  EAX,28[ESI]
  MOV  EDX,24[ESI]
  MUL  EDX
  SUB  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
  SUB  EBP,EAX
  SBB  ECX,EDX
  SBB  EBX,0
  MOV  20 [EDI],EBP
; 6  0  6 
  MOV  EAX,0[ESI]
  MOV  EDX,24[ESI]
  MOV  EBP,EBX
  SAR  EBP,31
  ADD  EBX,ZW
  ADC  EBP,0
  MUL  EDX
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
; 6  1  5 
  MOV  EAX,4[ESI]
  MOV  EDX,20[ESI]
  MUL  EDX
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
; 6  2  4 
  MOV  EAX,8[ESI]
  MOV  EDX,16[ESI]
  MUL  EDX
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
; 6  3  3 
  MOV  EAX,12[ESI]
  MUL  EAX
  ADD  ECX,EAX
  ADC  EBX,EDX
  ADC  EBP,0
; 6  7  7 
  MOV  EAX,28[ESI]
  MUL  EAX
  SUB  ECX,EAX
  SBB  EBX,EDX
  SBB  EBP,0
  MOV  24 [EDI],ECX
  MOV  28 [EDI],EBX
  MOV  32 [EDI],EBP
; 486 clock ticks: 760 
XfftQk:  SUB    ZSind,2
         JNZ    XfftQe
         RETN
;
; Start of cycle
XfftQs:  MOV    EAX,0[ESI]
         MOV    0[EDI],EAX
         MOV    EAX,4[ESI]
         MOV    4[EDI],EAX
         MOV    EAX,8[ESI]
         MOV    8[EDI],EAX
         MOV    EAX,12[ESI]
         MOV    12[EDI],EAX
         MOV    EAX,16[ESI]
         MOV    16[EDI],EAX
         MOV    EAX,20[ESI]
         MOV    20[EDI],EAX
         MOV    EAX,24[ESI]
         MOV    24[EDI],EAX
         MOV    EAX,28[ESI]
         MOV    28[EDI],EAX
         MOV    EAX,32[ESI]
         MOV    32[EDI],EAX
         JMP    XfftQk
;
; (2^256)^2 = 1 (mod F)
XfftQu:  MOV    dword ptr 0[EDI],1
         MOV    dword ptr 4[EDI],0
         MOV    dword ptr 8[EDI],0
         MOV    dword ptr 12[EDI],0
         MOV    dword ptr 16[EDI],0
         MOV    dword ptr 20[EDI],0
         MOV    dword ptr 24[EDI],0
         MOV    dword ptr 28[EDI],0
         MOV    dword ptr 32[EDI],0
         JMP    XfftQk
;====================================================
;
;
_AR2F80A endp
_TEXT    ends
         END    
